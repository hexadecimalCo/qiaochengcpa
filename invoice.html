<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <meta name="theme-color" content="#ffffff" />
  <title>發票計算機</title>
  <script>
    tailwind.config = {
      darkMode: false,
      theme: {
        extend: {
          colors: {
            brand: '#1758C8'
          }
        }
      }
    }
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    [v-cloak] {
      display: none
    }
  </style>
</head>

<body>
  <div id="app" v-cloak class="max-w-[1320px] mx-auto mt-6">
    <div class="bg-white border border-slate-200 shadow-sm p-6">

      <!-- Tabs -->
      <div class="flex justify-center">
        <div class="gap-6 px-2">
          <button class="relative px-4 py-3 text-slate-600"
            :class="tab==='triple' ? 'text-amber-600 font-medium' : 'hover:text-slate-800'" @click="tab='triple'">
            <span class="inline-flex items-center gap-2">
              <img src="./images/company.svg" alt="" class="w-6 h-6">
              <span>三聯式發票（公司）</span>
            </span>
            <span class="absolute left-0 right-0 -bottom-[1px] h-[3px] bg-amber-500 rounded"
              v-show="tab==='triple'"></span>
          </button>

          <button class="relative px-4 py-3 text-slate-600"
            :class="tab==='double' ? 'text-amber-600 font-medium' : 'hover:text-slate-800'" @click="tab='double'">
            <span class="inline-flex items-center gap-2">
              <img src="./images/users.svg" alt="" srcset="" class="w-6 h-6">
              <span>二聯式發票（個人）</span>
            </span>
            <span class="absolute left-0 right-0 -bottom-[1px] h-[3px] bg-amber-500 rounded"
              v-show="tab==='double'"></span>
          </button>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:[grid-template-columns:35%_65%] gap-8 mt-6">
        <!-- 左側表單 -->
        <section>
          <div class="space-y-6">
            <!-- 買受人 -->
            <div v-if="tab==='triple'">
              <h3 class="text-lg font-semibold mb-3">買受人</h3>
              <p class="text-sm text-slate-500 mb-4">輸入統編可自動帶出公司名稱，輸入公司名稱相同字串以上可自動帶出建議</p>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm text-slate-600 mb-1">統一編號</label>
                  <input v-model.trim="buyer.taxId" inputmode="numeric" maxlength="8"
                    class="w-full rounded-lg border border-slate-200 px-3 py-2" placeholder="請輸入統編" />
                </div>
                <div>
                  <label class="block text-sm text-slate-600 mb-1">發票抬頭</label>
                  <input v-model.trim="buyer.title" class="w-full rounded-lg border border-slate-200 px-3 py-2"
                    placeholder="請輸入公司名稱" />
                </div>
              </div>
            </div>

            <!-- 金額 -->
            <div>
              <h3 class="text-lg font-semibold mb-3">金額</h3>
              <p class="text-sm text-slate-500 mb-4">可輸入含稅或未稅任一欄，系統即時帶出金額</p>

              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <!-- 含稅 -->
                <div>
                  <label class="block text-sm text-slate-600 mb-1">收款金額（含稅額）</label>
                  <div class="relative">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">NT$</span>
                    <input type="text" inputmode="numeric" pattern="[0-9]*" maxlength="11" :value="inclusiveDisplay"
                      @input="onInclusiveInput" class="w-full rounded-lg border border-slate-200 pl-12 pr-3 py-2" />
                  </div>
                </div>

                <!-- 營業稅額 -->
                <div>
                  <label class="block text-sm text-slate-600 mb-1">營業稅額</label>
                  <div class="relative">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">NT$</span>
                    <input type="text" :value="vatAmount" disabled
                      class="w-full rounded-lg border border-slate-200 bg-slate-100 text-slate-700 pl-12 pr-3 py-2" />
                  </div>
                </div>

                <!-- 稅率 -->
                <div>
                  <label class="block text-sm text-slate-600 mb-1">稅率</label>
                  <div class="relative">
                    <select v-model="taxType"
                      class="w-full rounded-lg border border-slate-200 px-3 py-2 appearance-none pr-8 bg-white">
                      <option value="應稅">應稅(5%)</option>
                      <option value="零稅率">零稅率</option>
                      <option value="免稅">免稅</option>
                    </select>
                    <svg class="pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"
                      viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd"
                        d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.08 1.04l-4.25 4.25a.75.75 0 01-1.08 0L5.21 8.27a.75.75 0 01.02-1.06z"
                        clip-rule="evenodd" />
                    </svg>
                  </div>
                </div>

                <!-- 未稅 -->
                <div>
                  <label class="block text-sm text-slate-600 mb-1">銷售額（未稅額）</label>
                  <div class="relative">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">NT$</span>
                    <input type="text" inputmode="numeric" pattern="[0-9]*" maxlength="11" :value="exclusiveDisplay"
                      @input="onExclusiveInput" class="w-full rounded-lg border border-slate-200 pl-12 pr-3 py-2" />
                  </div>
                </div>
              </div>

              <button class="mt-4 inline-flex items-center gap-2 bg-[#EBEBEB] px-4 py-2 rounded-[6px]"
                @click="resetForm">重新填寫</button>
            </div>
          </div>
        </section>

        <!-- 右側預覽 -->
        <section>
          <h3 class="text-lg font-semibold mb-3">發票範例圖</h3>
          <div class="w-full overflow-x-auto overflow-y-hidden" style="-webkit-overflow-scrolling: touch;">
            <div ref="invoicePreview" class="relative bg-white w-[800px] overflow-x-scroll">
              <img :src="invoiceSrc" alt="發票範例圖" class="w-full rounded-lg shadow-sm select-none pointer-events-none" />
              <div v-if="tab==='triple'"
                class="invoiceText absolute left-24 top-[70px] text-[#1758C8] font-semibold select-none">{{
                buyer.title || '必填'
                }}</div>
              <div v-if="tab==='triple'"
                class="invoiceText absolute top-[104px] left-[183px] -translate-x-1/2 flex gap-[4px] leading-none select-none">
                <span v-for="(ch, i) in taxIdSlots" :key="i"
                      class="inline-block w-[18px] text-center text-[#1758C8] font-bold text-[18px]">
                  {{ ch }}
                </span>
              </div>
              <div class="invoiceText absolute left-[50%] text-[#1758C8] font-bold text-[18px] opacity-80 select-none"
                :class="tab==='triple' ? 'bottom-[70px] ' : 'bottom-[107px]'">
                {{ inclusiveDisplay }}
              </div>
              <div
                class="invoiceText absolute left-[50%] top-[193px] text-[#1758C8] font-bold text-[18px] opacity-80 select-none">
                {{ tab==='triple' ? exclusiveDisplay : inclusiveDisplay }}
              </div>
              <div
                class="invoiceText absolute left-[314px] top-[197px] text-[#1758C8] font-bold text-[12px] opacity-80 select-none">
                {{ tab==='triple' ? exclusiveDisplay : inclusiveDisplay }}
              </div>
              <div v-if="tab==='triple'"
                class="invoiceText absolute bottom-[100px] left-[50%] text-[#1758C8] font-bold text-[18px] opacity-80 select-none">
                {{ vatAmount }}
              </div>
              <div class="invoiceText absolute text-[#1758C8] font-bold text-[18px] opacity-80 select-none"
                :class="taxTypeTag">
                V
              </div>
              <div class="invoiceText absolute top-[47px] text-[#1758C8] font-bold text-[18px] opacity-80 select-none"
                :class="monthPairInChinese[0]==='十一' ? 'left-[383px]' : 'left-[390px]'">
                <span :class="monthPairInChinese[0]==='十一' ? 'pr-6' : 'pr-8'">{{ monthPairInChinese[0] }}</span>
                <span>{{ monthPairInChinese[1] }}</span>
              </div>
              <div
                class="invoiceText absolute left-[405px] text-[#1758C8] font-bold text-[18px] opacity-80 select-none" :class="tab==='triple' ? 'top-[100px] w-[160px]' : 'top-[98px] w-[170px]'">
                <div class="relative w-full">
                  <span class="absolute -translate-x-1/2 w-[32px]" :class="tab==='triple' ? 'left-[16px]' : 'left-[16px]'">{{ new Date().getFullYear()-1911 }}</span>
                  <span class="absolute -translate-x-1/2 w-[24px] text-center" :class="tab==='triple' ? 'left-[75px]' : 'left-[80px]'">{{ new Date().getMonth() + 1 }}</span>
                  <span class="absolute -translate-x-1/2 w-[24px] text-center" :class="tab==='triple' ? 'right-[10px]' : 'right-[0px]'">{{ new Date().getDate() }}</span>
                </div>
              </div>
              <div v-if="tab==='triple'"
                class="invoiceText absolute top-[194px] left-[260px] text-[#1758C8] font-bold text-[18px] opacity-80 select-none">
                1
              </div>
              <div
                class="invoiceText absolute top-[47px] left-[295px] text-[#1758C8] font-bold text-[18px] opacity-80 select-none">
                {{rocYearInChineseDigits}}
              </div>
              <div class="absolute top-[145px] left-[14px] font-bold text-[18px] opacity-80 border-t border-[#1758C8] border-4 select-none w-[680px]">
              </div>
              <div class="invoiceText absolute left-[87px] flex justify-end gap-[20px] leading-none"
                :class="tab==='triple' ? 'bottom-[42px]' : 'bottom-[82px]'">
                <div class="invoiceTextLine absolute left-0 top-1/2 translate-y-[-2px] h-[4px] bg-[#1758C8]"
                  :style="{ width: emptiesWidth }"></div>
                <span v-for="(ch, i) in chineseSlots" :key="i"
                  class="relative inline-block w-[31px] h-[22px] text-center select-none">
                  <span v-if="ch" class="relative z-10 text-[#1758C8] font-bold text-[18px] leading-[22px]">
                    {{ ch }}
                  </span>
                </span>
              </div>
              <div v-if="tab==='triple'"
                class="invoiceText absolute bottom-[130px] left-[50%] text-[#1758C8] font-bold text-[18px] opacity-80 select-none">
                {{ exclusiveDisplay}}
              </div>
            </div>
          </div>
        </section>
      </div>
      <div class="mt-8 w-full flex justify-center">
        <button @click="downloadImage"
          class="inline-flex items-center justify-center gap-2 bg-[#FDB902] text-[#202020] font-medium px-6 py-3 shadow w-[480px] rounded-[6px]">
          <img src="./images/download.svg" alt="" srcset="">
          下載圖片
        </button>
      </div>
    </div>
  </div>

  <script type="module">
    import { createApp, ref, computed, watch } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js'

    createApp({
      setup() {
        // Tabs：三聯（公司）/ 二聯（個人）
        const tab = ref('triple')
        const invoiceSrc = computed(() => tab.value === 'triple' ? './images/invoice-triple.svg' : './images/invoice-double.svg')
        const invoicePreview = ref(null)

        // 欄位
        const buyer = ref({ taxId: '', title: '' })
        const rate = ref(0.05)
        const taxType = ref('應稅')

        // 內部狀態：用「來源」紀錄使用者最後輸入的是含稅或未稅，避免互相覆蓋
        const source = ref('inclusive') // 'inclusive' | 'exclusive'
        const inclusive = ref(0)        // 含稅金額
        const exclusive = ref(0)        // 未稅金額

        // 當稅率改變，依來源重算
        watch(rate, () => {
          if (source.value === 'inclusive') {
            exclusive.value = toExclusive(inclusive.value, rate.value)
          } else {
            inclusive.value = toInclusive(exclusive.value, rate.value)
          }
        })

        watch(taxType, () => {
          if (taxType.value === '應稅') {
            rate.value = 0.05
          } else {
            rate.value = 0
          }
        })

        const POS = {
          triple: {
            '應稅': 'bottom-[90px] left-[25%]',
            '零稅率': 'bottom-[90px] left-[35%]',
            '免稅': 'bottom-[90px] left-[45%]',
          },
          double: {
            '應稅': 'bottom-[50px] left-[33%]',
            '零稅率': 'bottom-[50px] left-[50%]',
            '免稅': 'bottom-[50px] left-[65%]',
          },
        }
        const MAX_LEN = 9
        const MAX_INC = 999_999_999
        const MAX_EXC = 952_380_951
        const SLOT_W = 31 // 每個大寫國字寬度
        const GAP = 20  // 間距
        const TAX_ID_LEN = 8
        const taxIdSlots = computed(() => {
          const s = (buyer.value.taxId || '').replace(/\D/g, '').slice(0, TAX_ID_LEN)
          return Array.from({ length: TAX_ID_LEN }, (_, i) => s[i] || '')
        })

        const moneyFmt = (n) => new Intl.NumberFormat('zh-TW', {
            maximumFractionDigits: 0,
            useGrouping: true,
          }).format(Number(n) || 0)

        const onlyDigits = s => String(s ?? '').replace(/\D/g, '')
        // 金額轉換
        const round0 = n => Math.max(0, Math.round(Number(n) || 0))
        const toExclusive = (inc, r) => (Number(inc) || 0) / (1 + (Number(r) || 0))
        const toInclusive = (exc, r) => (Number(exc) || 0) * (1 + (Number(r) || 0))
        // 顯示（保留整數，符合你截圖的 $0 風格）
        const inclusiveDisplay = computed(() => moneyFmt(inclusive.value))
        const exclusiveDisplay = computed(() => moneyFmt(exclusive.value))
        const vatAmount = computed(() => moneyFmt(exclusive.value * rate.value))
        const taxTypeTag = computed(() => POS[tab.value]?.[taxType.value] ?? 'bottom-0 left-0')

        const rocYearInChineseDigits = computed(() => {
          const roc = new Date().getFullYear() - 1911; // 2025 → 114
          const map = ['零', '一', '二', '三', '四', '五', '六', '七', '八', '九'];
          return String(roc).split('').map(d => map[Number(d)]).join(''); // 114 → "一一四"
        })

        const mapDigitToUpper = (d) => (['零', '壹', '貳', '參', '肆', '伍', '陸', '柒', '捌', '玖'])[d];

        const chineseSlots = computed(() => {
          const n = round0(inclusive.value);
          const s = n === 0 ? '' : String(n);

          // 固定 9 格，從右往左填入
          const slots = Array(MAX_LEN).fill('');
          if (n === 0) {
            // 將「零」放在最右邊（個位數格）
            slots[MAX_LEN - 1] = '零'
            return slots
          }
          for (let i = 0; i < s.length && i < MAX_LEN; i++) {
            const digit = Number(s[s.length - 1 - i]);
            slots[MAX_LEN - 1 - i] = mapDigitToUpper(digit);
          }
          return slots;
        });

        const emptiesWidth = computed(() => {
          const used = String(round0(inclusive.value)).length
          const empties = Math.max(0, MAX_LEN - used)
          return `${empties * (SLOT_W + GAP)}px`
        })

        const numToCnMonth = (n) => {
          const d = ['', '一', '二', '三', '四', '五', '六', '七', '八', '九'];
          if (n <= 10) return n === 10 ? '十' : d[n];
          return '十' + d[n - 10]; // 11→十一, 12→十二
        }

        const monthPairInChinese = computed(() => {
          const m = new Date().getMonth() + 1; // 1~12
          const start = m % 2 === 0 ? m - 1 : m; // 偶數回到前一個奇數
          const end = start + 1;
          return [numToCnMonth(start), numToCnMonth(end)];
        })

        // 輸入事件
        const onInclusiveInput = (e) => {
          let val = Number(onlyDigits(e.target.value)) || 0
          if (val > MAX_INC) val = MAX_INC
          e.target.value = String(val)

          source.value = 'inclusive'
          inclusive.value = val
          exclusive.value = round0(toExclusive(val, rate.value))
        }
        const onExclusiveInput = (e) => {
          let val = Number(onlyDigits(e.target.value)) || 0
          if (val > MAX_EXC) val = MAX_EXC
          e.target.value = String(val)

          source.value = 'exclusive'
          exclusive.value = val
          // 反推含稅
          const inc = round0(toInclusive(val, rate.value))
          inclusive.value = inc > MAX_INC ? MAX_INC : inc
        }

        const resetForm = () => {
          buyer.value = { taxId: '', title: '' }
          source.value = 'inclusive'
          inclusive.value = 0
          exclusive.value = 0
          rate.value = 0.05
        }

        const downloadImage = async () => {
          if (!invoicePreview.value) return
          const canvas = await html2canvas(invoicePreview.value, {
            backgroundColor: '#ffffff', // 白底
            scale: 2,                     // 較高解析度 
            onclone: (doc) => {
              doc.querySelectorAll('.invoiceText').forEach((el) => {
                el.style.transform = 'translate(0, -8px)';
              });
              doc.querySelector('.invoiceTextLine').style.transform = 'translate(0, 8px)';
            }
          })
          const link = document.createElement('a')
          link.download = 'invoice.png'
          link.href = canvas.toDataURL('image/png')
          link.click()
        }


        return {
          tab, buyer, rate, taxType, taxTypeTag,
          inclusiveDisplay, exclusiveDisplay, vatAmount,
          onInclusiveInput, onExclusiveInput, resetForm,
          invoiceSrc, invoicePreview, downloadImage,taxIdSlots,
          rocYearInChineseDigits, monthPairInChinese, chineseSlots, emptiesWidth
        }
      }
    }).mount('#app')
  </script>
</body>

</html>
