<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>發票計算機</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    [v-cloak] {
      display: none
    }
  </style>
</head>

<body class="min-h-dvh">
  <div id="app" v-cloak class="max-w-7xl mx-auto p-6">
    <div class="bg-white border border-slate-200 shadow-sm p-6">

      <!-- Tabs -->
      <div class="flex justify-center ">
        <div class="gap-6 px-2">
          <button class="relative px-4 py-3 text-slate-600"
            :class="tab==='triple' ? 'text-amber-600 font-medium' : 'hover:text-slate-800'" @click="tab='triple'">
            <span class="inline-flex items-center gap-2">
              <img src="./images/company.svg" alt="" class="w-6 h-6">
              <span>三聯式發票（公司）</span>
            </span>
            <span class="absolute left-0 right-0 -bottom-[1px] h-[3px] bg-amber-500 rounded"
              v-show="tab==='triple'"></span>
          </button>
  
          <button class="relative px-4 py-3 text-slate-600"
            :class="tab==='double' ? 'text-amber-600 font-medium' : 'hover:text-slate-800'" @click="tab='double'">
            <span class="inline-flex items-center gap-2">
              <img src="./images/users.svg" alt="" srcset="" class="w-6 h-6">
              <span>二聯式發票（個人）</span>
            </span>
            <span class="absolute left-0 right-0 -bottom-[1px] h-[3px] bg-amber-500 rounded"
              v-show="tab==='double'"></span>
          </button>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:[grid-template-columns:35%_65%] gap-8 mt-6">
        <!-- 左側表單 -->
        <section>
          <div class="space-y-6">
            <!-- 買受人 -->
            <div>
              <h3 class="text-lg font-semibold mb-3">買受人</h3>
              <p class="text-sm text-slate-500 mb-4">輸入統編可自動帶出公司名稱，輸入公司名稱相同字串以上可自動帶出建議</p>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm text-slate-600 mb-1">統一編號</label>
                  <input v-model.trim="buyer.taxId" inputmode="numeric" maxlength="8"
                    class="w-full rounded-lg border border-slate-200 px-3 py-2" placeholder="請輸入統編" />
                </div>
                <div>
                  <label class="block text-sm text-slate-600 mb-1">發票抬頭</label>
                  <input v-model.trim="buyer.title" class="w-full rounded-lg border border-slate-200 px-3 py-2"
                    placeholder="請輸入公司名稱" />
                </div>
              </div>
            </div>

            <!-- 金額 -->
            <div>
              <h3 class="text-lg font-semibold mb-3">金額</h3>
              <p class="text-sm text-slate-500 mb-4">可輸入含稅或未稅任一欄，系統即時帶出金額</p>

              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <!-- 含稅 -->
                <div>
                  <label class="block text-sm text-slate-600 mb-1">收款金額（含稅額）</label>
                  <div class="relative">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">NT$</span>
                    <input type="number" min="0" step="1" :value="inclusiveDisplay"
                      @input="onInclusiveInput($event.target.value)"
                      class="w-full rounded-lg border border-slate-200 pl-12 pr-3 py-2" placeholder="NT$" />
                  </div>
                </div>

                <!-- 營業稅額 -->
                <div>
                  <label class="block text-sm text-slate-600 mb-1">營業稅額</label>
                  <div class="relative">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">NT$</span>
                    <input type="text" :value="formatMoney(vatAmount)" disabled
                      class="w-full rounded-lg border border-slate-200 bg-slate-100 text-slate-700 pl-12 pr-3 py-2" />
                  </div>
                </div>

                <!-- 稅率 -->
                <div>
                  <label class="block text-sm text-slate-600 mb-1">稅率</label>
                  <select v-model.number="rate" class="w-full rounded-lg border border-slate-200 px-3 py-2 bg-white">
                    <option :value="0.05">應稅(5%)</option>
                    <option :value="0">零稅率/免稅(0%)</option>
                  </select>
                </div>

                <!-- 未稅 -->
                <div>
                  <label class="block text-sm text-slate-600 mb-1">銷售額（未稅額）</label>
                  <div class="relative">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">NT$</span>
                    <input type="number" min="0" step="1" :value="exclusiveDisplay"
                      @input="onExclusiveInput($event.target.value)"
                      class="w-full rounded-lg border border-slate-200 pl-12 pr-3 py-2" placeholder="NT$" />
                  </div>
                </div>
              </div>

              <button
                class="mt-4 inline-flex items-center gap-2 rounded-lg border border-slate-200 px-4 py-2 hover:bg-slate-50"
                @click="resetForm">重新填寫</button>
            </div>
          </div>
        </section>

        <!-- 右側預覽 -->
        <section>
          <h3 class="sr-only">發票範例圖</h3>
          <div ref="invoicePreview" class="relative border border-slate-200 rounded-xl p-4 bg-white">
            <img :src="invoiceSrc" alt="發票範例圖" class="w-full rounded-lg shadow-sm select-none pointer-events-none" />
            <div class="absolute left-24 top-[74px] text-[#FDB902] font-semibold select-none">{{ buyer.title || '必填' }}</div>
            <div class="absolute left-[104px] top-[100px] text-[#FDB902] font-bold text-[18px] opacity-80 select-none" :class="buyer.taxId ? 'tracking-[8px]' : 'tracking-[0px]'">
              {{ buyer.taxId || '必填' }}
            </div>
          </div>
        </section>
      </div>
      <div class="mt-8 w-full flex justify-center"> 
        <button @click="downloadImage"
          class="inline-flex items-center justify-center gap-2 bg-[#FDB902] text-[#202020] font-medium px-6 py-3 shadow w-[480px]">
          <img src="./images/download.svg" alt="" srcset="">
          下載圖片
        </button>
      </div>
    </div>
  </div>

  <script type="module">
    import { createApp, ref, computed, watch } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js'

    createApp({
      setup() {
        // Tabs：三聯（公司）/ 二聯（個人）
        const tab = ref('triple')
        const invoiceSrc = ref('./images/invoice.svg')
        const invoicePreview = ref(null)

        // 欄位
        const buyer = ref({ taxId: '', title: '' })
        const rate = ref(0.05)

        // 內部狀態：用「來源」紀錄使用者最後輸入的是含稅或未稅，避免互相覆蓋
        const source = ref('inclusive') // 'inclusive' | 'exclusive'
        const inclusive = ref(0)        // 含稅金額
        const exclusive = ref(0)        // 未稅金額

        // 當稅率改變，依來源重算
        watch(rate, () => {
          if (source.value === 'inclusive') {
            exclusive.value = toExclusive(inclusive.value, rate.value)
          } else {
            inclusive.value = toInclusive(exclusive.value, rate.value)
          }
        })

        // 金額轉換
        const toExclusive = (inc, r) => (Number(inc) || 0) / (1 + (Number(r) || 0))
        const toInclusive = (exc, r) => (Number(exc) || 0) * (1 + (Number(r) || 0))
        const round0 = (n) => Math.max(0, Math.round(Number(n) || 0))

        // 顯示（保留整數，符合你截圖的 $0 風格）
        const inclusiveDisplay = computed(() => round0(inclusive.value))
        const exclusiveDisplay = computed(() => round0(exclusive.value))

        const vatAmount = computed(() => round0(exclusive.value * rate.value))

        // 輸入事件
        const onInclusiveInput = (val) => {
          source.value = 'inclusive'
          inclusive.value = Number(val) || 0
          exclusive.value = toExclusive(inclusive.value, rate.value)
        }
        const onExclusiveInput = (val) => {
          source.value = 'exclusive'
          exclusive.value = Number(val) || 0
          inclusive.value = toInclusive(exclusive.value, rate.value)
        }

        const resetForm = () => {
          buyer.value = { taxId: '', title: '' }
          source.value = 'inclusive'
          inclusive.value = 0
          exclusive.value = 0
          rate.value = 0.05
        }

        const formatMoney = (n) =>
          (Number.isFinite(n) ? n : 0)
            .toLocaleString('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 })
            .replace('$', 'NT$ ')

        const downloadImage = async () => {
          if (!invoicePreview.value) return
          const canvas = await html2canvas(invoicePreview.value, {
            backgroundColor: '#ffffff', // 白底
            scale: 2                     // 較高解析度
          })
          const link = document.createElement('a')
          link.download = 'invoice.png'
          link.href = canvas.toDataURL('image/png')
          link.click()
        }


        return {
          tab, buyer, rate,
          inclusiveDisplay, exclusiveDisplay, vatAmount,
          onInclusiveInput, onExclusiveInput, resetForm,
          formatMoney, invoiceSrc, invoicePreview, downloadImage
        }
      }
    }).mount('#app')
  </script>
</body>

</html>
