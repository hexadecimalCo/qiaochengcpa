<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>租金分攤試算（Vue CDN）</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    [v-cloak] {
      display: none
    }
  </style>
</head>

<body class="min-h-dvh bg-slate-50">
  <div id="app" v-cloak class="max-w-7xl mx-auto p-4">
    <div class="bg-white border border border-slate-200 rounded-2xl shadow-sm p-6">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

        <!-- 左側表單 -->
        <section>
          <h2 class="text-xl font-semibold mb-4">房東</h2>

          <!-- 分頁 -->
          <div class="flex border-b border-slate-200">
            <button class="flex-1 px-6 py-3 text-center" :class="tab==='person'
                ? 'bg-[#FEDC80] text-slate-900 border-b-2 border-amber-500 font-medium'
                : 'bg-[#F9FAFB] text-slate-500 border-b-2 hover:bg-slate-50'" @click="switchTab('person')">
              個人
            </button>
            <button class="flex-1 px-6 py-3 text-center" :class="tab==='company'
                ? 'bg-[#FEDC80] text-slate-900 border-b-2 border-amber-500 font-medium'
                : 'bg-[#F9FAFB] text-slate-500 border-b-2 hover:bg-slate-50'" @click="switchTab('company')">
              公司
            </button>
          </div>

          <!-- 房東列 -->
          <div class="space-y-4 mt-4" v-if="tab==='person'">
            <div v-for="(ll, idx) in landlords" :key="ll.id" class="grid grid-cols-1 gap-3 items-end"
              :class="idx === 0 ? 'sm:[grid-template-columns:30%_30%_1fr_auto]': 'sm:[grid-template-columns:28%_28%_28%_auto]',
              landlords.length>=2 ? 'border border-2 border-black p-4 md:border-0 md:p-0'  : ''">
              <!-- 房東名稱（唯讀展示） -->
              <div>
                <label class="block text-sm text-slate-500 mb-1">房東</label>
                <input class="w-full rounded-lg border border-slate-200 bg-slate-100 px-3 py-2 text-[#9CA3AF]"
                  :value="`房東${idx+1}`" disabled>
              </div>

              <!-- 身份 -->
              <div>
                <label class="block text-sm text-slate-500 mb-1">身份</label>
                <div class="relative">
                  <select v-model="ll.identity"
                    class="w-full rounded-lg border border-slate-200 px-3 py-2 appearance-none pr-8 bg-white">
                    <option value="local">本國人</option>
                    <option value="foreign">外國人</option>
                  </select>
                  <svg class="pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"
                    viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd"
                      d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.08 1.04l-4.25 4.25a.75.75 0 01-1.08 0L5.21 8.27a.75.75 0 01.02-1.06z"
                      clip-rule="evenodd" />
                  </svg>
                </div>
              </div>

              <!-- 持有比例 -->
              <div>
                <label class="block text-sm text-slate-500 mb-1">持有比例 (%)</label>
                <input type="number" min="0" max="100" step="0.01" v-model.number="ll.share"
                  class="w-full rounded-lg border border-slate-200 px-3 py-2" @blur="normalizeShares" />
              </div>

              <!-- 刪除 -->
              <div class="h-[42px] flex items-center justify-center lg:justify-start" v-if="idx>=1">
                <button class="inline-flex items-center justify-center lg:w-9 lg:h-9 rounded-md border border-transparent"
                  @click="removeLandlord(idx)" aria-label="刪除房東">
                  <img src="./images/round-box-cross.svg" alt="" />
                  <span class="sm:hidden pl-2">刪除房東{{idx+1}}</span>
                </button>
              </div>
            </div>

            <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div class="col-span-12 sm:col-span-3">
                <button
                  class="px-3 py-2 rounded-lg border border border-slate-200 hover:bg-slate-50 flex items-center gap-2"
                  @click="duplicateLandlord(idx)">
                  <img src="./images/circle-plus.svg" alt="新增房東" class="w-4 h-4">
                  新增房東</button>
              </div>
            </div>

            <!-- 每期租金 -->
            <div class="mt-6">
              <div>
                <label class="block text-sm text-slate-500 mb-1">每期租金</label>
                <div class="relative">
                  <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">NT$</span>
                  <input type="number" min="0" step="1" v-model.number="rent"
                    class="w-full rounded-lg border border-slate-200 pl-12 pr-3 py-2" />
                </div>
              </div>

              <div class="mt-6 flex items-end gap-6">
                <label class="inline-flex items-center gap-2 cursor-pointer">
                  <input type="radio" class="hidden peer" value="tax_included" v-model="taxMode" />
                  <span class="relative w-4 h-4 rounded-full border
                        border-slate-300
                        peer-checked:border-amber-500
                        after:content-[''] after:absolute after:inset-1 after:rounded-full
                        after:bg-amber-500 after:opacity-0
                        peer-checked:after:opacity-100">
                  </span>
                  <span class="text-slate-700 ">租金含稅</span>
                </label>

                <label class="inline-flex items-center gap-2 cursor-pointer">
                  <input type="radio" class="hidden peer" value="tax_excluded" v-model="taxMode" />
                  <span class="relative w-4 h-4 rounded-full border
                        border-slate-300
                        peer-checked:border-amber-500
                        after:content-[''] after:absolute after:inset-1 after:rounded-full
                        after:bg-amber-500 after:opacity-0
                        peer-checked:after:opacity-100">
                  </span>
                  <span class="text-slate-700">租金未含稅</span>
                </label>
              </div>
            </div>
            </div>
            <div v-else>
              <div class="mt-6">
                <label class="block text-sm mb-2">每期租金</label>
                <div class="relative">
                  <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">NT$</span>
                  <input type="number" min="0" step="1"
                    class="w-full rounded-lg border border-slate-200 pl-12 pr-3 py-2" />
                </div>
              </div>
            </div>
        </section>

        <!-- 右側結果 -->
        <section>
          <h2 class="text-xl font-semibold mb-4">試算結果</h2>

          <div class="bg-[#F2F2F2] p-6">
            <div v-if="tab==='person'" v-for="(ll, idx) in landlords" :key="ll.id"
              class="mb-4">
              <div class="mb-3 text-xl font-bold text-[#4C4C4C]">
                房東{{ idx+1 }}： {{ '{' + identityLabel(ll) + '}' }}
              </div>
              <ul class="space-y-2">
                <li class="flex justify-between">
                  <span class="text-[#4C4C4C]">每期租金（{{ taxMode === 'tax_included' ? '含稅' : '未稅' }}）</span>
                  <span class="text-[#C81717] font-semibold">{{ moneyFmt(shareBase(ll)) }}</span>
                </li>
                <li class="flex justify-between items-start">
                  <span class="inline-flex items-center gap-2 text-[#4C4C4C]">
                    扣繳 {{ (withholdingRate(ll)*100).toFixed(0) }}%
                    <div class="relative inline-block group">
                      <img src="./images/info-circle.svg" alt="" class="w-4 h-4 cursor-pointer">
                      <!-- Tooltip -->
                      <div
                        class="absolute left-full top-1/2 -translate-y-1/2 ml-2
                              w-[200px] px-3 py-2 rounded bg-slate-800 text-white text-xs leading-relaxed
                              opacity-0 group-hover:opacity-100 transition pointer-events-none z-10"
                      >
                        扣繳只是先預繳房東個人綜合所得稅，不是會損失的稅金。<br/>
                        會視房東個人綜所稅稅率退稅。<br/>
                        例如：如果房東不需繳個人綜合所得稅，10% 就可以全額退回。
                        <!-- 箭頭 -->
                        <div class="absolute top-1/2 -translate-y-1/2 -left-1 w-2 h-2 rotate-45 bg-slate-800"></div>
                      </div>
                    </div>
                  </span>
                  <span class="text-[#C81717] font-semibold">
                    -{{ moneyFmt(shareBase(ll) * withholdingRate(ll)) }}
                  </span>
                </li>
                <li class="flex justify-between">
                  <span class="text-[#4C4C4C]">二代健保 2.11%</span>
                  <span class="text-[#C81717] font-semibold" :class="!applyNhi(ll) ? 'opacity-40 line-through' : ''">
                    -{{ moneyFmt(applyNhi(ll) ? shareBase(ll) * 0.0211 : 0) }}
                  </span>
                </li>
                <li class="flex justify-between">
                  <span class="text-[#4C4C4C]">租扣二代總金額</span>
                  <span class="text-[#C81717] font-semibold" :class="!applyNhi(ll) ? 'opacity-40 line-through' : ''">
                    -{{ moneyFmt(applyNhi(ll) ? shareBase(ll) * 0.0211 : 0) }}
                  </span>
                </li>
                <li class="flex justify-between">
                  <span class="text-[#4C4C4C]">實際支付租金（未稅）</span>
                  <span class="text-[#C81717] font-semibold">{{ moneyFmt(payable(ll)) }}</span>
                </li>
              </ul>
              <p class="mt-2 text-xs text-[#4C4C4C]">* 本國人應於次月 10 日前繳納健保補充費。</p>
              <div class="border-t-4 border-[#E9AC06] mt-4 mb-6" v-if="idx<landlords.length-1"></div>
            </div>
            <div>
              <div class="mb-3 text-xl font-bold text-[#4C4C4C]">
                若房東是公司，則應跟房東索取租金發票，發票總金額為 $50,000 元
              </div>
              <ul class="space-y-2">
                <li class="flex justify-between">
                  <span class="text-[#4C4C4C]">銷售額</span>
                  <span class="text-[#C81717] font-semibold">123</span>
                </li>
                <li class="flex justify-between">
                  <span class="text-[#4C4C4C]">稅額</span>
                  <span class="text-[#C81717] font-semibold">123</span>
                </li>
                <li class="flex justify-between">
                  <span class="text-[#4C4C4C]">總金額</span>
                  <span class="text-[#C81717] font-semibold">123</span>
                </li>
              </ul>
            </div>
          </div>
        </section>

      </div>
    </div>
  </div>

  <script type="module">
    import { createApp, ref, computed } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js'

    createApp({
      setup() {
        const tab = ref('person') // person | company
        const rent = ref(0)
        const taxMode = ref('tax_included') // tax_included | tax_excluded
        const landlords = ref([
          { id: 1, identity: 'local', share: 100 }
        ])

        const switchTab = (t) => {
          tab.value = t
        }

        const duplicateLandlord = (idx) => {
          const nextId = Math.max(...landlords.value.map(l => l.id)) + 1
          landlords.value.splice(idx + 1, 0, {
            id: nextId,
            identity: 'local',
            share: 0
          })
          evenShares()
        }

        const removeLandlord = (idx) => {
          if (landlords.value.length === 1) return
          landlords.value.splice(idx, 1)
          evenShares()
        }

        const evenShares = () => {
          const n = landlords.value.length
          const base = Math.floor((100 / n) * 100) / 100 // 取兩位
          landlords.value.forEach((l, i) => {
            l.share = i === n - 1 ? +(100 - base * (n - 1)).toFixed(2) : base
          })
        }

        const normalizeShares = () => {
          // 讓總和 ≈ 100（允許微小誤差），最後一位調整
          const n = landlords.value.length
          if (n === 0) return
          let sum = landlords.value.slice(0, n - 1).reduce((a, l) => a + (Number(l.share) || 0), 0)
          landlords.value[n - 1].share = +(100 - sum).toFixed(2)
        }

        // 計算基礎（依含稅/未稅只做展示用，未做逆推）
        const shareBase = (ll) => {
          const ratio = (Number(ll.share) || 0) / 100
          return Math.max(0, (Number(rent.value) || 0) * ratio)
        }

        const withholdingRate = (ll) => {
          if (tab.value === 'company') return 0.10  // 簡化：公司 10%
          if (ll.identity === 'foreign') return 0.10 // 簡化：外國人 10%
          return 0.00                                 // 本國人 0%
        }

        const applyNhi = (ll) => {
          // 簡化：僅「個人本國人」計 2.11%
          return tab.value === 'person' && ll.identity === 'local'
        }

        const payable = (ll) => {
          const base = shareBase(ll)
          const w = base * withholdingRate(ll)
          const nhi = applyNhi(ll) ? base * 0.0211 : 0
          // 示意：實付（未稅）= 基礎 - 扣繳 - 健保
          return Math.max(0, base - w - nhi)
        }

        const identityLabel = (ll) => {
          if (tab.value === 'company') return '公司'
          return ll.identity === 'foreign' ? '外國人' : '本國人'
        }

        const moneyFmt = (n) => {
          const v = isFinite(n) ? n : 0
          return v.toLocaleString('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).replace('$', 'NT$ ')
        }

        const totalBase = computed(() => landlords.value.reduce((s, l) => s + shareBase(l), 0))
        const totalWithheld = computed(() => landlords.value.reduce((s, l) => s + shareBase(l) * withholdingRate(l), 0))
        const totalNhi = computed(() => landlords.value.reduce((s, l) => s + (applyNhi(l) ? shareBase(l) * 0.0211 : 0), 0))
        const totalPayable = computed(() => landlords.value.reduce((s, l) => s + payable(l), 0))

        return {
          tab, rent, taxMode, landlords,
          switchTab, duplicateLandlord, removeLandlord,
          evenShares, normalizeShares,
          shareBase, withholdingRate, applyNhi, payable,
          identityLabel, moneyFmt,
          totalBase, totalWithheld, totalNhi, totalPayable
        }
      }
    }).mount('#app')
  </script>
</body>

</html>
