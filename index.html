<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vue + Tailwind Dropdown (CDN Components)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    [v-cloak] {
      display: none
    }
  </style>
</head>

<body class="min-h-dvh grid place-items-center bg-slate-50">
  <div id="app" v-cloak></div>

  <script type="module">
    import {
      createApp, ref, onMounted, onBeforeUnmount, nextTick
    } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js'

    // 子元件：Dropdown
    const Dropdown = {
      name: 'Dropdown',
      props: {
        label: { type: String, default: '選單' },
        items: {
          type: Array,
          default: () => ([
            { key: 'profile', label: 'Profile' },
            { key: 'settings', label: 'Settings' },
            { key: 'signout', label: 'Sign out' },
          ])
        },
        width: { type: [Number, String], default: 192 },
        align: { type: String, default: 'left' }, // 'left' | 'right'
      },
      emits: ['select'],
      setup(props, { emit }) {
        const open = ref(false)
        const activeIndex = ref(0)
        const root = ref(null)
        const options = ref([])

        const toggle = async () => {
          open.value = !open.value
          if (open.value) {
            activeIndex.value = 0
            await nextTick()
            options.value?.[0]?.focus?.()
          }
        }
        const onClickOutside = (e) => {
          if (!root.value) return
          if (!root.value.contains(e.target)) open.value = false
        }
        const onFocusOut = (e) => {
          if (root.value && root.value.contains(e.relatedTarget)) return
          open.value = false
        }
        const move = async (step) => {
          if (!open.value) { open.value = true; await nextTick() }
          const len = props.items.length
          activeIndex.value = (activeIndex.value + step + len) % len
          await nextTick()
          options.value?.[activeIndex.value]?.focus?.()
        }
        const activate = () => {
          const item = props.items[activeIndex.value]
          if (item) onSelect(item)
        }
        const onSelect = (item) => {
          emit('select', item)
          open.value = false
        }

        onMounted(() => document.addEventListener('mousedown', onClickOutside))
        onBeforeUnmount(() => document.removeEventListener('mousedown', onClickOutside))

        const panelAlignClass = () => (props.align === 'right' ? 'right-0' : 'left-0')
        const panelInlineStyle = () => ({ width: typeof props.width === 'number' ? `${props.width}px` : props.width })

        return { open, activeIndex, root, options, toggle, move, activate, onSelect, onFocusOut, panelAlignClass, panelInlineStyle }
      },
      template: `
        <div class="relative inline-block" ref="root"
            @keydown.escape="open=false" @focusout="onFocusOut">
          <button
            type="button"
            class="inline-flex items-center gap-2 rounded-xl px-3 py-2 bg-white border border-slate-200 shadow hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-blue-500"
            :aria-expanded="open ? 'true' : 'false'"
            aria-haspopup="menu"
            @click="toggle"
            @keydown.arrow-down.prevent="move(1)"
            @keydown.arrow-up.prevent="move(-1)"
          >
            {{ label }}
            <svg class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
              <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 011.08 1.04l-4.25 4.25a.75.75 0 01-1.08 0L5.21 8.27a.75.75 0 01.02-1.06z" clip-rule="evenodd"/>
            </svg>
          </button>

          <div
            v-show="open"
            class="absolute z-10 mt-2 rounded-xl border border-slate-200 bg-white shadow overflow-hidden"
            :class="panelAlignClass()"
            :style="panelInlineStyle()"
            role="menu" tabindex="-1"
            @keydown.arrow-down.prevent="move(1)"
            @keydown.arrow-up.prevent="move(-1)"
            @keydown.enter.prevent="activate"
          >
            <button
              v-for="(item, idx) in items"
              :key="item.key ?? idx"
              ref="options"
              type="button"
              class="w-full text-left px-4 py-2 hover:bg-slate-50 focus:bg-slate-100 focus:outline-none"
              :class="idx===activeIndex ? 'bg-slate-50' : ''"
              role="menuitem"
              @mouseenter="activeIndex = idx"
              @click="onSelect(item)"
            >
              {{ item.label }}
            </button>
          </div>
        </div>
      `
    }

    // 父元件 App：把畫面放在 template 裡
    const App = {
      components: { Dropdown },
      setup() {
        const selected = ref('（尚未選取）')
        const menuItems = ref([
          { key: 'profile', label: 'Profile' },
          { key: 'settings', label: 'Settings' },
          { key: 'signout', label: 'Sign out' },
        ])
        const onSelect = (item) => { selected.value = item.label }
        return { selected, menuItems, onSelect }
      },
      template: `
        <main class="p-8 rounded-2xl shadow bg-white w-[28rem] space-y-6">
          <h1 class="text-xl font-semibold">分元件示範</h1>
          <Dropdown label="功能選單" :items="menuItems" @select="onSelect" />
          <div class="text-slate-600">選取結果：<span class="font-medium">{{ selected }}</span></div>
        </main>
      `
    }

    createApp(App).mount('#app')
  </script>
</body>

</html>
